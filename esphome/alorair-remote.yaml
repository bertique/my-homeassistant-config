esphome:
  name: "alorair-remote"
  friendly_name: Alorair Remote
  min_version: 2024.11.0
  name_add_mac_suffix: false

esp32:
  board: esp32dev
  framework:
    type: arduino

# Enable logging
logger:
#  level: VERY_VERBOSE

# Enable Home Assistant API
api:

# Allow Over-The-Air updates
ota:
- platform: esphome

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password


light:
  - platform: status_led
    pin: GPIO04
    name: "Status LED"

# +--------------------------------------+
# | LilyGo T-CAN485 related config       |
# +--------------------------------------+

output:
  # MAX13487E SHDN (enable RS485 chip)
  - platform: gpio
    id: RS485_SE
    pin:
      number: 19
      inverted: true # set HIGH level
  # MAX13487E RE (enable RS485 autodirection)
  - platform: gpio
    id: RS485_EN
    pin:
      number: 17
      inverted: true # set HIGH level
  # RS485 and CAN Boost power supply
  - platform: gpio
    id: CGQ_EN
    pin:
      number: 16
      inverted: true # set HIGH level
  # SN65HVD231DR RS PIN (CAN high speed mode)
  - platform: gpio
    id: CAN_SE
    pin:
      number: 23
      inverted: false # set LOW level

# https://tinymicros.com/wiki/AlorAir_Sentinel_HD55_Dehumidifier
# https://community.home-assistant.io/t/automate-alorair-sentinel-hd55-dehumidifier/306084/23
canbus:
  - platform: esp32_can
    tx_pin: GPIO27
    rx_pin: GPIO26
    can_id: 0x05
    #bit_rate: 50kbps
    bit_rate: 125kbps
    use_extended_id: false
    on_frame:
    - can_id: 0x123
      then:
      - logger.log:
          format: "%02x %02x %02x %02x %02x %02x %02x %02x"
          args: [ 'x[0]', 'x[1]', 'x[2]', 'x[3]', 'x[4]', 'x[5]', 'x[6]', 'x[7]' ]
      - sensor.template.publish:
          id: humidity_actual
          state: !lambda 'return x[0];'
      - sensor.template.publish:
          id: humidity_setpoint
          state: !lambda 'return x[1];'
      - sensor.template.publish:
          id: temperature
          state: !lambda 'return x[2];'
      - sensor.template.publish:
          id: byte_3
          state: !lambda 'return x[3];'
      - sensor.template.publish:
          id: byte_4
          state: !lambda 'return x[4];'
      - binary_sensor.template.publish:
          id: draining
          state: !lambda 'return (x[4] & 0x10) == 0x10;'
      - binary_sensor.template.publish:
          id: running
          state: !lambda 'return (x[4] & 0x02) == 0x02;'
      - binary_sensor.template.publish:
          id: power
          state: !lambda 'return (x[4] & 0x01) == 0x01;'
      - sensor.template.publish:
          id: byte_5
          state: !lambda 'return x[5];'
      - sensor.template.publish:
          id: byte_6
          state: !lambda 'return x[6];'
      - sensor.template.publish:
          id: byte_7
          state: !lambda 'return x[7];'
            
interval:
  - interval: 60s
    then:
      - canbus.send:
          data: [ 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 ]
          can_id: 0x123      

sensor:
  # Uptime sensor.
  - platform: uptime
    name: Uptime
    disabled_by_default: true

  # WiFi Signal sensor.
  - platform: wifi_signal
    name: WiFi Signal
    update_interval: 60s
    disabled_by_default: true

  - platform: template
    name: Humidity
    id: humidity_actual
    accuracy_decimals: 0
    unit_of_measurement: "%"
    device_class: "humidity"
    state_class: "measurement"
  - platform: template
    name: Humidity Setpoint
    id: humidity_setpoint
    accuracy_decimals: 0
    unit_of_measurement: "%"
    device_class: "humidity"
    state_class: "measurement"
  - platform: template
    name: Temperature
    id: temperature
    accuracy_decimals: 0
    unit_of_measurement: "Â°C"
    device_class: "temperature"
    state_class: "measurement"

  - platform: template
    name: Byte 3
    id: byte_3
    accuracy_decimals: 0
  - platform: template
    name: Byte 4
    id: byte_4
    accuracy_decimals: 0
  - platform: template
    name: Byte 5
    id: byte_5
    accuracy_decimals: 0
  - platform: template
    name: Byte 6
    id: byte_6
    accuracy_decimals: 0
  - platform: template
    name: Byte 7
    id: byte_7
    accuracy_decimals: 0

binary_sensor:
  - platform: template
    name: Draining
    id: draining
  - platform: template
    name: Running
    id: running
  - platform: template
    name: Power
    id: power

switch:
  - platform: template
    name: "Enable Dehumidifier"
    id: enable_dehumid
    restore_mode: DISABLED
    lambda: |-
      if (id(power).state) {
        return true;
      } else {
        return false;
      }
    turn_on_action:
      - canbus.send:
          data: [ 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00 ]
          can_id: 0x123
      - delay: 100ms
      - canbus.send:
          data: [ 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 ]
          can_id: 0x123
    turn_off_action:
      - canbus.send:
          data: [ 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00 ]
          can_id: 0x123
      - delay: 100ms
      - canbus.send:
          data: [ 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 ]
          can_id: 0x123
number:
  - platform: template
    name: "Set Point"
    min_value: 20
    max_value: 99
    step: 1
    device_class: humidity
    unit_of_measurement: "%"      
    set_action: 
      - then:
        - canbus.send:
            data: !lambda |-
              return {(uint8_t)(x+128), 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };
            can_id: 0x123
        - delay: 100ms
        - canbus.send:
            data: [ 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 ]
            can_id: 0x123
    lambda: |-
      return(id(humidity_setpoint).state);
